<?php

namespace app\modules\thirdParty\controllers;

use app\modules\common\models\InsuranceCompanies;
use app\modules\Fanavaran\models\core\Conf;
use app\modules\thirdParty\models\Inquiry;
use app\modules\thirdParty\models\ThirdPartyInquiry;
use yii\rest\ActiveController;
use yii\web\Controller;
use yii\web\Response as webResponse;

class InquiryController extends ActiveController
{


    public $modelClass = ThirdPartyInquiry::class;

    public function behaviors()
    {
        $parent = parent::behaviors(); // TODO: Change the autogenerated stub

        $parent['corsFilter'] = [
            'class' => \yii\filters\Cors::class,
        ];

        $parent['contentNegotiator'] = [
            'class' => 'yii\filters\ContentNegotiator',
            'formats' => [ 'application/json' => webResponse::FORMAT_JSON ]
        ];

        return $parent;
    }


    public function actions(): array
    {
        $actions = parent::actions(); // TODO: Change the autogenerated stub
        unset($actions['create']);
//        $actions['index']['prepareDataProvider'] = [$this, 'prepareDataProvider'];
//        $actions['view']['findModel'] = [$this, 'oneDataProvider'];
        return $actions;
    }

//    public function actionIndex(): array
//    {
//
//        $req = \Yii::$app->request->post();
//
//
//
//        try {
//
//            $vehicleKindId = $req['vehicleModel']['value'];
//            $usedId = $req['vehicleUx']['value'];
//            $plaqueKindId = 1; # default value 1 , vehicle_group_id = 1 , name= 'عمومی'
//            $plaqueSampleId = null;
//
//            # reqion
//            $freeRegionId = null; # city id , default value null
//            $isInFreeRegion = 0; # default value , id 0 , value 'خیر'
//
//            $calcKindId = isset($req['validityDuration']) ? $req['validityDuration']['value'] : 221; # default id 221 # 1 year
//
//
//# شرکت بیمه گر قبلی
//            $previousInsuranceCorpId = $req['insuranceCompany']['value'];
//
//            # spare
//            $hasSpare = 232; # default value , id 232 , caption 'ندارد'
//            $spareCount = null;
//            $sparePlaqueDate = null;
//
//            $years = explode('-' , $req['vehicleYear']); # 1402 - 2020
//            $builtYear =  trim($years[0]); # date pas shamsi
//
//
//            $beginDate = null;
//            $endDate = null;
//            $plaqueDate = null;
//
//
//            $isNewCar = 0;
//
//# پوشش مالی
//            $financialCov = 1600;
//            $lifeCov = 8000;
//            $driverAccidentsCov = 270;
//
//
//
//            # خسارت
//            $lifeDmgCount = null;
//            $financialDmgCount = null;
//            $driverAccidentsDmgCount = null;
//
//
//
//            $previousPolicyBeginDate = null;
//            $previousPolicyEndDate = null;
//
//
//            # تخفیفات
//
//            $previousPolicyDiscountDuration = null; # سنوات تخفیف ثالث بیمه نامه قبل
//            $previousPolicyDriverAccidentsDiscountDuration = null;
//            $previousPolicyDiscountPercent = null;
//            $previousPolicyDriverAccidentsDiscountPercent = null;
//
//            if($previousInsuranceCorpId == 1)
//            {
//
//                # خودرو صفر کیلومتر
//
//                $isNewCar = 1;
//                $previousInsuranceCorpId = 320; # change id insurance corp , undefined insurance
//
//                #  تاریخ شماره گذاری
//                $plaqueDate = $req['dateDischarge'];
//            }
//            else if($previousInsuranceCorpId == 320)
//            {
//
//                # فاقد بیمه
//                # previousInsuranceCorpId == 320
//
//
//
//                # تخفیفات
//                $previousPolicyDiscountDuration = 0; # سنوات تخفیف ثالث بیمه نامه قبل
//                $previousPolicyDriverAccidentsDiscountDuration = 0;
//                $previousPolicyDiscountPercent = 0;
//                $previousPolicyDriverAccidentsDiscountPercent = 0;
//
//
//
//            }
//            else if(($previousInsuranceCorpId != 1) && ($previousInsuranceCorpId != 320))
//            {
//
//                # خودرو دارا بیمه
//
//                # تاریخ بیمه نامه قبل
//                $previousPolicyBeginDate = $req['dateStart'];
//                $previousPolicyEndDate = $req['dateEnd'];
//
//                # تخفیفات
//                $previousPolicyDiscountDuration = 0; # سنوات تخفیف ثالث بیمه نامه قبل
//                $previousPolicyDriverAccidentsDiscountDuration = 0;
//                $previousPolicyDiscountPercent = !empty($req['percentThirdParty']) ? $req['percentThirdParty'] : 0 ;
//                $previousPolicyDriverAccidentsDiscountPercent = !empty($req['percentDriver']) ? $req['percentDriver'] : 0 ;
//
//
//
//                $lifeDmgCount = 0;
//                $financialDmgCount = 0;
//                $driverAccidentsDmgCount = 0;
//
//                # خسارت
//                if (isset($req['damageHealth']['value']))
//                {
//                    $lifeDmgCount = $req['damageHealth']['value'];
//
//                }
//                else{
//                    $lifeDmgCount = 0;
//                }
//
//                if (isset($req['damageFinancial']['value']))
//                {
//                    $financialDmgCount = $req['damageFinancial']['value'];
//
//                }
//
//
//
//                if (isset($req['damageDriver']['value']))
//                {
//                    $driverAccidentsDmgCount = $req['damageDriver']['value'];
//
//                }
//
//            }
//
//        }catch (\Exception $err)
//        {
//            \Yii::$app->response->statusCode = 422;
//            return ['errors' => $err , 'line' =>    $err->getLine() , 'file'  , 'message' => $err->getMessage() , 'code' => $err->getCode() ];
//        }
//
//
//
//
//
//
//        $fan_map = [
//            'UsedId' => $usedId,
//            'VehicleKindId' => $vehicleKindId,
//            'IsNewCar' => $isNewCar,
//            'BuiltYear' => $builtYear,
//            'BeginDate' => $beginDate,
//            'EndDate' => $endDate,
//            'CalcKindId' => $calcKindId,
//            'FinancialCov' => $financialCov,
//            'FinancialDmgCount' => $financialDmgCount,
//            'FreeRegionId' => $freeRegionId,
//            'HasSpare' => $hasSpare,
//            'SpareCount' => $spareCount,
//            'SparePlaqueDate' => $sparePlaqueDate,
//            'IsInFreeRegion' => $isInFreeRegion,
//            'LifeCov' => $lifeCov,
//            'LifeDmgCount' => $lifeDmgCount,
//            'DriverAccidentsCov' => $driverAccidentsCov,
//            'DriverAccidentsDmgCount' => $driverAccidentsDmgCount,
//            'PlaqueDate' => $plaqueDate,
//            'PlaqueKindId' => $plaqueKindId,
//            'PlaqueSampleId' => $plaqueSampleId,
//            'PreviousInsuranceCorpId' => $previousInsuranceCorpId,
//            'PreviousPolicyBeginDate' => $previousPolicyBeginDate,
//            'PreviousPolicyEndDate' => $previousPolicyEndDate,
//            'PreviousPolicyDiscountDuration' => $previousPolicyDiscountDuration,
//            'PreviousPolicyDiscountPercent' => $previousPolicyDiscountPercent,
//            'PreviousPolicyDriverAccidentsDiscountDuration' => $previousPolicyDriverAccidentsDiscountDuration,
//            'PreviousPolicyDriverAccidentsDiscountPercent' => $previousPolicyDriverAccidentsDiscountPercent
//        ];
//
//
//        $model = new Inquiry();
//        $model->attributes = $fan_map;
//
//        $res =  $model->calculate();
//
//        if($res['status_code'] != 200)
//        {
//            \Yii::$app->response->statusCode = 422;
//            return ['errors' => $res , 'message' => 'fail curl , checking request fan' , 'code' => $res['status_code'] ];
//        }
//
//
//        $content = $res['content'];
//
//
//        $content = Conf::mapPascalCaseToSnakeCase($content);
//
//        $model = new ThirdPartyInquiry();
//        $model->attributes = $content;
//        $model->fan_inquiry_id = $content['id'];
//        $model->status = 1;
//        $model->vehicle_system_id = $req['vehicleBrand']['value'];
//        $model->vehicle_group_id = $req['vehicleType']['value'];
//        $model->has_damage = $req['hasDamage'] ? 1 : 0;
//        $model->discount_history = $req['discountHistory'];
//        $model->other_discount_plaque_iran_digit = $req['plaqueIranDigit'];
//        $model->other_discount_plaque_double_digit = $req['plaqueDoubleDigit'];
//        $model->other_discount_plaque_letter_caption = isset($req['plaqueAlphabet']["name"]) ? $req['plaqueAlphabet']["name"] : null;
//        $model->other_discount_plaque_letter_id = isset($req['plaqueAlphabet']["value"]) ? $req['plaqueAlphabet']["value"] : null;
//        $model->other_discount_plaque_triple_digit = $req['plaqueTripleDigit'];
//        $model->is_new_car = $previousInsuranceCorpId == 1  ? 1:0;
//        $model->is_ownership_changed = $req['isOwnershipChanged'] ? 1 :0 ;
//
//        if (!\Yii::$app->user->isGuest)
//        {
//            $model->user_id = \Yii::$app->user->getId(); # insert id user
//        }
//
//        if (!$model->save())
//        {
//            \Yii::$app->response->statusCode = 422;
//            return ['errors' => $model->errors , 'message' => 'fail request insert row' , 'code' => 500 ];
//        }
//        $insurance_corp = InsuranceCompanies::findOne(1);
//
//        if (empty($insurance_corp))
//        {
//            \Yii::$app->response->statusCode = 422;
//            return ['message' => 'not found , insurance company' , 'code' => 404];
//        }
//
//
//        return [
//            "thirdPartyInsuranceList" => [
//                [
//
//                    'id' => $model->id,
//                    'fan_id' => $content['id'],
//                    "name" => $insurance_corp->name,
//                    'insurance_company_id' => $insurance_corp->id_insurance,
//                    'insurance_line_id' => 5,
//                    'insurance_line_category_id' => 4,
//                    "icon" => $insurance_corp->path_logo_insurance,
//                    "discountPercentage" => 0,
//                    "discount" => 0,
//                    "mainPrice" => 0,
//                    "finalPrice" => $res['content']['ThirdPartyFinalPrm'],
//                    "rate" => $insurance_corp->rate,
//                    'options' => [],
//                ]
//            ],
//            "inquiryDetails" => $req,
//            "totalCount" => 1
//        ];
//
//    }


    public function actionCreate(): array
    {

        $req = \Yii::$app->request->post();



        try {

            $vehicleKindId = $req['vehicleModel']['value'];
            $usedId = $req['vehicleUx']['value'];
            $plaqueKindId = 1; # default value 1 , vehicle_group_id = 1 , name= 'عمومی'
            $plaqueSampleId = null;

            # reqion
            $freeRegionId = null; # city id , default value null
            $isInFreeRegion = 0; # default value , id 0 , value 'خیر'

            $calcKindId = isset($req['validityDuration']) ? $req['validityDuration']['value'] : 221; # default id 221 # 1 year


# شرکت بیمه گر قبلی
            $previousInsuranceCorpId = $req['insuranceCompany']['value'];

            # spare
            $hasSpare = 232; # default value , id 232 , caption 'ندارد'
            $spareCount = null;
            $sparePlaqueDate = null;

            $years = explode('-' , $req['vehicleYear']); # 1402 - 2020
            $builtYear =  trim($years[0]); # date pas shamsi


            $beginDate = null;
            $endDate = null;
            $plaqueDate = null;


            $isNewCar = 0;

# پوشش مالی
            $financialCov = 1600;
            $lifeCov = 8000;
            $driverAccidentsCov = 270;



            # خسارت
            $lifeDmgCount = null;
            $financialDmgCount = null;
            $driverAccidentsDmgCount = null;



            $previousPolicyBeginDate = null;
            $previousPolicyEndDate = null;


            # تخفیفات

            $previousPolicyDiscountDuration = null; # سنوات تخفیف ثالث بیمه نامه قبل
            $previousPolicyDriverAccidentsDiscountDuration = null;
            $previousPolicyDiscountPercent = null;
            $previousPolicyDriverAccidentsDiscountPercent = null;

            if($previousInsuranceCorpId == 1)
            {

                # خودرو صفر کیلومتر

                $isNewCar = 1;
                $previousInsuranceCorpId = 320; # change id insurance corp , undefined insurance

                #  تاریخ شماره گذاری
                $plaqueDate = $req['dateDischarge'];
            }
            else if($previousInsuranceCorpId == 320)
            {

                # فاقد بیمه
                # previousInsuranceCorpId == 320



                # تخفیفات
                $previousPolicyDiscountDuration = 0; # سنوات تخفیف ثالث بیمه نامه قبل
                $previousPolicyDriverAccidentsDiscountDuration = 0;
                $previousPolicyDiscountPercent = 0;
                $previousPolicyDriverAccidentsDiscountPercent = 0;



            }
            else if(($previousInsuranceCorpId != 1) && ($previousInsuranceCorpId != 320))
            {

                # خودرو دارا بیمه

                # تاریخ بیمه نامه قبل
                $previousPolicyBeginDate = $req['dateStart'];
                $previousPolicyEndDate = $req['dateEnd'];

                # تخفیفات
                $previousPolicyDiscountDuration = 0; # سنوات تخفیف ثالث بیمه نامه قبل
                $previousPolicyDriverAccidentsDiscountDuration = 0;
                $previousPolicyDiscountPercent = !empty($req['percentThirdParty']) ? $req['percentThirdParty'] : 0 ;
                $previousPolicyDriverAccidentsDiscountPercent = !empty($req['percentDriver']) ? $req['percentDriver'] : 0 ;



                $lifeDmgCount = 0;
                $financialDmgCount = 0;
                $driverAccidentsDmgCount = 0;

                # خسارت
                if (isset($req['damageHealth']['value']))
                {
                    $lifeDmgCount = $req['damageHealth']['value'];

                }
                else{
                    $lifeDmgCount = 0;
                }

                if (isset($req['damageFinancial']['value']))
                {
                    $financialDmgCount = $req['damageFinancial']['value'];

                }



                if (isset($req['damageDriver']['value']))
                {
                    $driverAccidentsDmgCount = $req['damageDriver']['value'];

                }

            }

        }catch (\Exception $err)
        {
            \Yii::$app->response->statusCode = 422;
            return ['errors' => $err , 'line' =>    $err->getLine() , 'file'  , 'message' => $err->getMessage() , 'code' => $err->getCode() ];
        }






        $fan_map = [
            'UsedId' => $usedId,
            'VehicleKindId' => $vehicleKindId,
            'IsNewCar' => $isNewCar,
            'BuiltYear' => $builtYear,
            'BeginDate' => $beginDate,
            'EndDate' => $endDate,
            'CalcKindId' => $calcKindId,
            'FinancialCov' => $financialCov,
            'FinancialDmgCount' => $financialDmgCount,
            'FreeRegionId' => $freeRegionId,
            'HasSpare' => $hasSpare,
            'SpareCount' => $spareCount,
            'SparePlaqueDate' => $sparePlaqueDate,
            'IsInFreeRegion' => $isInFreeRegion,
            'LifeCov' => $lifeCov,
            'LifeDmgCount' => $lifeDmgCount,
            'DriverAccidentsCov' => $driverAccidentsCov,
            'DriverAccidentsDmgCount' => $driverAccidentsDmgCount,
            'PlaqueDate' => $plaqueDate,
            'PlaqueKindId' => $plaqueKindId,
            'PlaqueSampleId' => $plaqueSampleId,
            'PreviousInsuranceCorpId' => $previousInsuranceCorpId,
            'PreviousPolicyBeginDate' => $previousPolicyBeginDate,
            'PreviousPolicyEndDate' => $previousPolicyEndDate,
            'PreviousPolicyDiscountDuration' => $previousPolicyDiscountDuration,
            'PreviousPolicyDiscountPercent' => $previousPolicyDiscountPercent,
            'PreviousPolicyDriverAccidentsDiscountDuration' => $previousPolicyDriverAccidentsDiscountDuration,
            'PreviousPolicyDriverAccidentsDiscountPercent' => $previousPolicyDriverAccidentsDiscountPercent
        ];


        $model = new Inquiry();
        $model->attributes = $fan_map;

        $res =  $model->calculate();

        if($res['status_code'] != 200)
        {
            \Yii::$app->response->statusCode = 422;
            return ['errors' => $res , 'message' => 'fail curl , checking request fan' , 'code' => $res['status_code'] ];
        }


        $content = $res['content'];
        $content = Conf::mapPascalCaseToSnakeCase($content);

        $model = new ThirdPartyInquiry();
        $model->attributes = $content;
        $model->fan_inquiry_id = $content['id'];
        $model->status = 1;
        $model->vehicle_system_id = $req['vehicleBrand']['value'];
        $model->vehicle_group_id = $req['vehicleType']['value'];
        $model->has_damage = $req['hasDamage'] ? 1 : 0;
        $model->discount_history = $req['discountHistory'];
        $model->other_discount_plaque_iran_digit = $req['plaqueIranDigit'];
        $model->other_discount_plaque_double_digit = $req['plaqueDoubleDigit'];
        $model->other_discount_plaque_letter_caption = isset($req['plaqueAlphabet']["name"]) ? $req['plaqueAlphabet']["name"] : null;
        $model->other_discount_plaque_letter_id = isset($req['plaqueAlphabet']["value"]) ? $req['plaqueAlphabet']["value"] : null;
        $model->other_discount_plaque_triple_digit = $req['plaqueTripleDigit'];
        $model->is_new_car = $previousInsuranceCorpId == 1  ? 1:0;
        $model->is_ownership_changed = $req['isOwnershipChanged'] ? 1 :0 ;

        if (!\Yii::$app->user->isGuest)
        {
            $model->user_id = \Yii::$app->user->getId(); # insert id user
        }

        if (!$model->save())
        {
            \Yii::$app->response->statusCode = 422;
            return ['errors' => $model->errors , 'message' => 'fail request insert row' , 'code' => 500 ];
        }
        $insurance_corp = InsuranceCompanies::findOne(1);

        if (empty($insurance_corp))
        {
            \Yii::$app->response->statusCode = 422;
            return ['message' => 'not found , insurance company' , 'code' => 404];
        }


        return [
            "thirdPartyInsuranceList" => [
                [

                    'id' => $model->id,
                    'fan_id' => $content['id'],
                    "name" => $insurance_corp->name,
                    'insurance_company_id' => $insurance_corp->id_insurance,
                    'insurance_line_id' => 5,
                    'insurance_line_category_id' => 4,
                    "icon" => $insurance_corp->path_logo_insurance,
                    "discountPercentage" => 0,
                    "discount" => 0,
                    "mainPrice" => 0,
                    "finalPrice" => $res['content']['TotalPremium'],
                    "rate" => $insurance_corp->rate,
                    'options' => [],
                ]
            ],
            "inquiryDetails" => $req,
            "totalCount" => 1
        ];

    }


}